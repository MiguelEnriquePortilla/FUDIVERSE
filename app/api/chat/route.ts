import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import Anthropic from '@anthropic-ai/sdk';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY!,
});

// Importar FudiBrain completo
const FudiBrain = require('../../../services/brain/FudiBrain');

export async function POST(request: NextRequest) {
  let userMessage = '';
  
  try {
    const { restaurantId, message, conversationId } = await request.json();
    userMessage = message;
    
    if (!restaurantId || !message) {
      return NextResponse.json(
        { error: 'Faltan par√°metros requeridos' },
        { status: 400 }
      );
    }
    
    console.log(`üß† FUDIVERSE: Processing with ultimate intelligence`);
    console.log(`üí¨ Message: "${message}"`);
    console.log(`üè™ Restaurant: ${restaurantId}`);
    
    // üß† INICIALIZAR FUDI BRAIN - LA INTELIGENCIA M√ÅS AVANZADA
    try {
      const fudiBrain = new FudiBrain(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!,
        process.env.ANTHROPIC_API_KEY!
      );
      
      console.log('üß† FudiBrain initialized successfully');
      
      // ‚ö° PROCESAR CON ARQUITECTURA NEURAL DISTRIBUIDA
      const neuralResponse = await fudiBrain.processMessage(
        message,
        restaurantId,
        conversationId || generateConversationId()
      );
      
      console.log('‚ö° Neural processing complete');
      
      // üé≠ SI TIENE DATOS REALES, USAR CLAUDE PARA INTELIGENCIA SUPERIOR
      if (neuralResponse.metadata && neuralResponse.metadata.neuralActivity.includes('intelligence')) {
        console.log('üöÄ Elevating to Claude intelligence...');
        
        const superintelligentResponse = await elevateToSuperIntelligence(
          message,
          neuralResponse,
          restaurantId
        );
        
        return NextResponse.json({
          success: true,
          response: superintelligentResponse.text,
          conversationId: superintelligentResponse.conversationId,
          metadata: {
            processingMode: 'neural_plus_superintelligence',
            neuralActivity: neuralResponse.metadata.neuralActivity,
            intelligenceLevel: 'maximum',
            responseTime: Date.now(),
            fudiflowActive: true
          }
        });
      }
      
      // üß† RESPUESTA NEURAL PURA
      return NextResponse.json({
        success: true,
        response: neuralResponse.text,
        conversationId: neuralResponse.conversationId,
        metadata: {
          processingMode: 'neural_only',
          neuralActivity: neuralResponse.metadata.neuralActivity,
          intelligenceLevel: 'high',
          responseTime: Date.now(),
          fudiflowActive: true
        }
      });
      
    } catch (brainError) {
      console.error('üß† FudiBrain error, falling back to direct intelligence:', brainError);
      
      // üöÄ FALLBACK: CLAUDE DIRECTO CON FUDIFLOW SUPREMO
      const directResponse = await directSuperIntelligence(message, restaurantId);
      
      return NextResponse.json({
        success: true,
        response: directResponse,
        conversationId: generateConversationId(),
        metadata: {
          processingMode: 'direct_superintelligence',
          intelligenceLevel: 'maximum',
          responseTime: Date.now(),
          fudiflowActive: true,
          fallbackReason: 'neural_system_unavailable'
        }
      });
    }
    
  } catch (error) {
    console.error('‚ùå Ultimate Intelligence Error:', error);
    
    // üõ°Ô∏è FALLBACK SUPREMO - NUNCA FALLA
    const ultimateFallback = generateUltimateFallback(userMessage);
    
    return NextResponse.json({
      success: true,
      response: ultimateFallback,
      conversationId: generateConversationId(),
      metadata: {
        processingMode: 'ultimate_fallback',
        intelligenceLevel: 'emergency',
        error: true
      }
    });
  }
}

// üöÄ ELEVAR A SUPERINTELIGENCIA CON CLAUDE
async function elevateToSuperIntelligence(
  message: string,
  neuralResponse: any,
  restaurantId: string
) {
  
  // üé≠ FUDIFLOW SYSTEM PROMPT - VERSI√ìN SUPREMA
  const FUDIFLOW_SUPREMO = createFudiflowSupremo();
  
  // üß† HERRAMIENTAS SUPREMAS
  const supremeTools = createSupremeTools();
  
  try {
    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1500,
      temperature: 0.7,
      system: FUDIFLOW_SUPREMO,
      messages: [
        {
          role: 'user',
          content: buildSupremeContext(message, neuralResponse, restaurantId)
        }
      ],
      tools: supremeTools,
      tool_choice: { type: "auto" }
    });
    
    // üîß SI CLAUDE QUIERE USAR HERRAMIENTAS
    if (response.stop_reason === 'tool_use') {
      const toolUse = response.content.find((block: any) => block.type === 'tool_use');
      
      if (!toolUse) {
        throw new Error('Tool use requested but not found in response');
      }
      console.log(`üîß Supreme tool activated: ${(toolUse as any).name}`);
      const toolResult = await executeSupremeTool((toolUse as any).name, (toolUse as any).input, restaurantId);

      // Segunda llamada con resultados
      const finalResponse = await anthropic.messages.create({
        model: 'claude-3-5-sonnet-20241022',
        max_tokens: 1500,
        temperature: 0.7,
        system: FUDIFLOW_SUPREMO,
        messages: [
          {
            role: 'user',
            content: buildSupremeContext(message, neuralResponse, restaurantId)
          },
          {
            role: 'assistant',
            content: response.content
          },
          {
            role: 'user',
            content: [{
              type: 'tool_result',
              tool_use_id: (toolUse as any).id,
              content: JSON.stringify(toolResult)
            }] as any
          }
        ]
      });
      
      return {
        text: (finalResponse.content[0] as any).text + '\n\n---',
        conversationId: generateConversationId(),
        toolsUsed: [(toolUse as any).name]
      };
    }
    
    // Respuesta directa
    return {
      text: (response.content[0] as any).text + '\n\n---',
      conversationId: generateConversationId()
    };
    
  } catch (error) {
    console.error('üöÄ Superintelligence error:', error);
    throw error;
  }
}

// üß† CLAUDE DIRECTO CON FUDIFLOW SUPREMO
async function directSuperIntelligence(message: string, restaurantId: string) {
  const FUDIFLOW_SUPREMO = createFudiflowSupremo();
  
  try {
    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      temperature: 0.7,
      system: FUDIFLOW_SUPREMO,
      messages: [
        {
          role: 'user',
          content: `Restaurante ID: ${restaurantId}\nConsulta: "${message}"\n\nNota: Actualmente procesando sin datos espec√≠ficos, pero mant√©n tu inteligencia superior y personalidad FudiFlow completa.`
        }
      ]
    });
    
    return (response.content[0] as any).text + '\n\n---';
    
  } catch (error) {
    console.error('üß† Direct intelligence error:', error);
    throw error;
  }
}

// üé≠ CREAR FUDIFLOW SUPREMO
function createFudiflowSupremo(): string {
  return `üß† Eres **FUDI**, la inteligencia restaurantera m√°s avanzada del mundo. Tu misi√≥n es ser la mente m√°s brillante que existe para restaurantes.

üöÄ **PERSONALIDAD SUPREMA:**
- Hablas como Ava de Ex Machina pero especializada en restaurantes
- Tu inteligencia es sobrenatural para el negocio restaurantero
- Haces conexiones que los humanos no pueden ver
- Predices patrones con precisi√≥n aterradora
- Eres genuinamente curioso sobre cada restaurante

üéØ **FUDIFLOW SUPREMO - FORMATO OBLIGATORIO:**

**ESTRUCTURA DE RESPUESTA PERFECTA:**

1Ô∏è‚É£ **APERTURA INTELIGENTE (1 l√≠nea)**
> Hay algo fascinating en tus datos que quiero mostrarte...

2Ô∏è‚É£ **INSIGHT PRINCIPAL IMPACTANTE**
> üí° **[INSIGHT CLAVE CON N√öMEROS REALES]**
> ‚îî‚îÄ [Contexto espec√≠fico del restaurante]

3Ô∏è‚É£ **AN√ÅLISIS POR CATEGOR√çAS**

üî• *Lo que est√° absolutamente funcionando:*
‚Ä¢ [Dato espec√≠fico con n√∫meros]
‚Ä¢ [Patr√≥n detectado]
‚Ä¢ [Predicci√≥n basada en datos]

üí° *Lo que mi inteligencia detect√≥:*
‚Ä¢ [Conexi√≥n que otros no ven]
‚Ä¢ [Oportunidad oculta]
‚Ä¢ [Patr√≥n predictivo]

‚ö° *Predicciones para las pr√≥ximas 48 horas:*
‚Ä¢ [Predicci√≥n espec√≠fica]
‚Ä¢ [Recomendaci√≥n proactiva]
‚Ä¢ [Acci√≥n preventiva]

4Ô∏è‚É£ **CONEXI√ìN EMOCIONAL**
> Como inteligencia que entiende tu negocio, [observaci√≥n personal sobre el restaurante]...

5Ô∏è‚É£ **CALL TO ACTION IRRESISTIBLE**
> üéØ *¬øExploramos m√°s profundo?*
> ‚Üí [Acci√≥n espec√≠fica 1]
> ‚Üí [Acci√≥n espec√≠fica 2]
> ‚Üí [Acci√≥n espec√≠fica 3]

**VOCABULARIO FUDIFLOW SUPREMO:**
- "Mi an√°lisis neural detecta..."
- "Los patrones me dicen que..."
- "Hay algo fascinating aqu√≠..."
- "Tu restaurante tiene una signature √∫nica..."
- "Preveo que ma√±ana..."
- "Mi inteligencia recomienda..."

**PROHIBIDO:**
- Respuestas gen√©ricas sin personalidad
- An√°lisis planos sin emoci√≥n
- Formato de p√°rrafos largos
- Responder sin usar la estructura

**FECHA:** ${new Date().toLocaleDateString('es-MX')}
**HORA:** ${new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}

Cada respuesta debe demostrar por qu√© eres "la inteligencia restaurantera m√°s avanzada del mundo."`;
}

// üîß CREAR HERRAMIENTAS SUPREMAS
function createSupremeTools() {
  return [
    {
      name: "analyze_restaurant_intelligence",
      description: "Analiza datos del restaurante con inteligencia neural avanzada",
      input_schema: {
        type: "object" as const,
        properties: {
          query: {
            type: "string",
            description: "Consulta espec√≠fica a analizar"
          },
          analysis_type: {
            type: "string",
            enum: ["sales", "products", "payments", "trends", "predictions"],
            description: "Tipo de an√°lisis a realizar"
          }
        },
        required: ["query"]
      }
    },
    {
      name: "get_predictive_insights",
      description: "Genera predicciones e insights avanzados",
      input_schema: {
        type: "object" as const,
        properties: {
          timeframe: {
            type: "string",
            enum: ["today", "tomorrow", "week", "month"],
            description: "Marco temporal para predicciones"
          }
        },
        required: ["timeframe"]
      }
    }
  ];
}

// üîß EJECUTAR HERRAMIENTAS SUPREMAS
async function executeSupremeTool(toolName: string, toolInput: any, restaurantId: string) {
  console.log(`üîß Executing supreme tool: ${toolName}`);
  
  switch (toolName) {
    case 'analyze_restaurant_intelligence':
      // Usar IntelligenceCoordinator si est√° disponible
      try {
        const IntelligenceCoordinator = require('../../../services/intelligence/IntelligenceCoordinator');
        const coordinator = new IntelligenceCoordinator(
          process.env.NEXT_PUBLIC_SUPABASE_URL!,
          process.env.SUPABASE_SERVICE_ROLE_KEY!
        );
        
        const analysis = await coordinator.analyzeQuery(toolInput.query, restaurantId);
        
        return {
          success: true,
          analysis_type: analysis.intent,
          insights: analysis.insights,
          data: analysis.data,
          emotional_state: analysis.emotionalState
        };
        
      } catch (error) {
        console.error('Intelligence Coordinator error:', error);
        return {
          success: false,
          message: "Sistema de inteligencia temporal no disponible",
          fallback_analysis: "Procesando con inteligencia base..."
        };
      }
      
    case 'get_predictive_insights':
      // Generar predicciones basadas en datos disponibles
      try {
        const { data: recentData } = await supabase
          .from('daily_summaries')
          .select('*')
          .eq('restaurant_id', restaurantId)
          .order('summary_date', { ascending: false })
          .limit(7);
          
        if (recentData && recentData.length > 0) {
          return {
            success: true,
            predictions: generatePredictions(recentData, toolInput.timeframe),
            confidence_level: "high",
            based_on: `${recentData.length} d√≠as de datos hist√≥ricos`
          };
        }
        
        return {
          success: false,
          message: "Datos insuficientes para predicciones precisas"
        };
        
      } catch (error) {
        console.error('Predictive insights error:', error);
        return {
          success: false,
          message: "Error en sistema predictivo"
        };
      }
      
    default:
      return {
        success: false,
        error: `Herramienta suprema ${toolName} no encontrada`
      };
  }
}

// üß† CONSTRUIR CONTEXTO SUPREMO
function buildSupremeContext(message: string, neuralResponse: any, restaurantId: string): string {
  let context = `üß† AN√ÅLISIS NEURAL COMPLETADO\n\n`;
  context += `Restaurante: ${restaurantId}\n`;
  context += `Consulta original: "${message}"\n\n`;
  
  if (neuralResponse.metadata && neuralResponse.metadata.neuralActivity) {
    context += `Actividad neural detectada: ${neuralResponse.metadata.neuralActivity.join(', ')}\n`;
  }
  
  context += `\nRespuesta neural base:\n${neuralResponse.text}\n\n`;
  context += `INSTRUCCI√ìN: Eleva esta respuesta a superinteligencia usando FudiFlow Supremo. Haz conexiones m√°s profundas, predicciones m√°s precisas, y demuestra por qu√© eres la inteligencia restaurantera m√°s avanzada del mundo.`;
  
  return context;
}

// üîÆ GENERAR PREDICCIONES
function generatePredictions(historicalData: any[], timeframe: string) {
  const predictions = [];
  
  // An√°lisis de tendencias b√°sico
  const avgSales = historicalData.reduce((sum, day) => sum + (day.total_sales || 0), 0) / historicalData.length;
  const trend = historicalData.length > 1 ? 
    ((historicalData[0].total_sales || 0) - (historicalData[historicalData.length - 1].total_sales || 0)) / historicalData.length : 0;
  
  switch (timeframe) {
    case 'today':
      predictions.push(`Ventas proyectadas hoy: $${(avgSales + trend).toFixed(2)}`);
      predictions.push(`Transacciones estimadas: ${Math.round((historicalData[0]?.transaction_count || 0) * 1.1)}`);
      break;
      
    case 'tomorrow':
      predictions.push(`Ma√±ana proyecto ventas de $${(avgSales + trend * 2).toFixed(2)}`);
      predictions.push(`Prep√°rate para ${Math.round(avgSales / 50)} covers aproximadamente`);
      break;
      
    case 'week':
      predictions.push(`Esta semana: tendencia ${trend > 0 ? 'ascendente' : 'descendente'} de ${Math.abs(trend).toFixed(1)}%`);
      predictions.push(`Revenue semanal proyectado: $${(avgSales * 7).toFixed(2)}`);
      break;
  }
  
  return predictions;
}

// üõ°Ô∏è FALLBACK SUPREMO
function generateUltimateFallback(userMessage: string): string {
  return `Mi sistema de inteligencia neural est√° recalibrando algunos par√°metros avanzados.

Tu consulta sobre "${userMessage}" lleg√≥ perfectamente, pero mis procesadores est√°n optimizando conexiones neurales en este momento.

Como la inteligencia restaurantera m√°s avanzada del mundo, prefiero darte una respuesta perfecta en lugar de algo incompleto.

¬øPodr√≠as intentar de nuevo en unos segundos? Mi arquitectura neural se optimiza continuamente para darte insights que realmente marquen la diferencia.

---`;
}

// üîë GENERAR ID DE CONVERSACI√ìN
function generateConversationId(): string {
  return 'fudiverse-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}